// 添加app端样式
addAppCss();
Jinx();
ipMap();

// 给玩偶添加拖拽事件和删除事件
const interval = setInterval(() => {
  const element = document.getElementById('live2d-widget'); // 查找元素
  if (element) {
    moveDoll();
    console.log('元素已找到，清除定时器');
    clearInterval(interval); // 清除定时器
  }
}, 500); // 每 500ms 检查一次

 
// app环境不添加网易云外链
// app环境网易云外链不支持，自动加载http的东西，和博客网站https冲突
if (isMobile()) {
  // moveDoll();
} else {
  musicBox();
  removeMusicBox();
}

function addMoveDollButton() {
  // 获取元素
  const live2dWidget = document.getElementById("live2d-widget");
  console.log(live2dWidget);
  if(live2dWidget) {
    const newDiv = document.createElement('div');
    newDiv.classList.add('close-doll');
    live2dWidget.appendChild(newDiv);
    var myBtn = document.querySelector(".close-doll");
    myBtn.addEventListener("click", function () {
      var doll = document.querySelector(".live2d-widget-container");
      doll.style.display = "none";
      doll.remove();
    });
  }
}
 
 
function moveDoll() {
    //添加删除按钮
    addMoveDollButton();

    // 添加拖拽按钮
  const draggableElement = document.getElementById("live2d-widget");
  if (!draggableElement) {
    console.error("live2d-widget 元素未找到！");
    return;
  }

  let isDragging = false;
  let offsetX = 0, offsetY = 0;

  // **PC 端鼠标事件**
  draggableElement.addEventListener("mousedown", (event) => {
    isDragging = true;
    offsetX = event.clientX - draggableElement.getBoundingClientRect().left;
    offsetY = event.clientY - draggableElement.getBoundingClientRect().top;
    draggableElement.style.cursor = "grabbing";
  });

  document.addEventListener("mousemove", (event) => {
    if (isDragging) {
      moveAt(event.clientX, event.clientY);
    }
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
    draggableElement.style.cursor = "grab";
  });

  // **移动端触摸事件**
  draggableElement.addEventListener("touchstart", (event) => {
    if (event.touches.length > 1) return; // 防止多指触摸干扰

    isDragging = true;
    const touch = event.touches[0];
    offsetX = touch.clientX - draggableElement.getBoundingClientRect().left;
    offsetY = touch.clientY - draggableElement.getBoundingClientRect().top;
  });

  document.addEventListener("touchmove", (event) => {
    if (isDragging) {
      const touch = event.touches[0];
      moveAt(touch.clientX, touch.clientY);
      event.preventDefault(); // 阻止滚动页面
    }
  }, { passive: false });

  document.addEventListener("touchend", () => {
    isDragging = false;
  });

  // **更新位置**
  function moveAt(x, y) {
    let newX = x - offsetX;
    let newY = y - offsetY;

    // **防止超出屏幕**
    newX = Math.max(0, Math.min(window.innerWidth - draggableElement.clientWidth, newX));
    newY = Math.max(0, Math.min(window.innerHeight - draggableElement.clientHeight, newY));

    draggableElement.style.left = `${newX}px`;
    draggableElement.style.top = `${newY}px`;
  }
}


// 写这里应该没人发现吧😃😃😃
function Jinx() {
  console.log(
    "%c Jinx天天开心哈哈哈哈哈哈 %c https://jinx66.gitee.io/",
    "color:#fff;font-size: 14px;font-family: serif;background:linear-gradient(90deg,#ff4d91,#ff4d91);padding:15px 10px;",
    "color:#000;background:linear-gradient(90deg,#ff4d91,#ffffff);padding:15px 10px;font-size: 14px;font-family: serif;"
  );
}

function ipMap() {
  //添加iframe标签
  var body = document.getElementsByTagName("body");
  var div = document.createElement("div");
  div.innerHTML =
    '<a href="https://clustrmaps.com/site/1bv4l" title="Visit tracker"><img src="//www.clustrmaps.com/map_v2.png?d=NN6CrFgiT6g5STfQdgu1v91lB8TY5dqmU7iLIxocfY0&cl=ffffff"></a>';
  div.id = "ip-map";
  document.body.appendChild(div);
}
function addAppCss() {
  if (isMobile()) {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "/app.css"; // 替换为您CSS文件的路径
    document.head.appendChild(link);
  }
}
function musicBox() {
  //添加iframe标签
  var body = document.getElementsByTagName("body");
  var div = document.createElement("div");
  div.innerHTML =
    '<div id="drag" class="move"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=300 src="https://music.163.com/outchain/player?type=0&id=2327585234&auto=1&height=430"></iframe><div class="mask"></div><div class="close"></div></div>';
  document.body.appendChild(div);
  // 拖拽功能(主要是触发三个事件：onmousedown\onmousemove\onmouseup)
  var drag = document.getElementById("drag");
  var divMask = document.querySelector(".mask");

  // 点击某物体时，用drag对象即可，move和up是全局区域，也就是整个文档通用，应该使用document对象而不是drag对象(否则，采用drag对象时物体只能往右方或下方移动)
  drag.onmousedown = function (e) {
    var e = e || window.event; // 兼容ie浏览器
    var diffX = e.clientX - drag.offsetLeft; // 鼠标点击物体那一刻相对于物体左侧边框的距离=点击时的位置相对于浏览器最左边的距离-物体左边框相对于浏览器最左边的距离
    var diffY = e.clientY - drag.offsetTop;

    /* 低版本ie bug:物体被拖出浏览器可是窗口外部时，还会出现滚动条，
                      解决方法是采用ie浏览器独有的2个方法setCapture()\releaseCapture(),这两个方法，
                      可以让鼠标滑动到浏览器外部也可以捕获到事件，而我们的bug就是当鼠标移出浏览器的时候，
                      限制超过的功能就失效了。用这个方法，即可解决这个问题。注：这两个方法用于onmousedown和onmouseup中 */
    if (typeof drag.setCapture !== "undefined") {
      drag.setCapture();
    }

    divMask.style.width = "100%";
    divMask.style.height = "100%";
    document.onmousemove = function (e) {
      var e = e || window.event; // 兼容ie浏览器
      var left = e.clientX - diffX;
      var top = e.clientY - diffY;

      // 控制拖拽物体的范围只能在浏览器视窗内，不允许出现滚动条
      if (left < 0) {
        left = 0;
      } else if (left > window.innerWidth - drag.offsetWidth) {
        left = window.innerWidth - drag.offsetWidth;
      }
      if (top < 0) {
        top = 0;
      } else if (top > window.innerHeight - drag.offsetHeight) {
        top = window.innerHeight - drag.offsetHeight;
      }

      // 移动时重新得到物体的距离，解决拖动时出现晃动的现象
      drag.style.left = left + "px";
      drag.style.top = top + "px";
    };
    document.onmouseup = function (e) {
      // 当鼠标弹起来的时候不再移动
      console.log("this", this);
      this.onmousemove = null;
      this.onmouseup = null; // 预防鼠标弹起来后还会循环（即预防鼠标放上去的时候还会移动）

      // 修复低版本ie bug
      if (typeof drag.releaseCapture !== "undefined") {
        drag.releaseCapture();
      }

      divMask.style.width = "0";
      divMask.style.height = "0";
    };
  };
  const draggableElement = document.getElementById("drag");

  // 存储上一个触摸位置的坐标
  let lastTouchX = 0;
  let lastTouchY = 0;

  draggableElement.addEventListener("touchstart", function (event) {
    // 记录触摸开始时的位置
    const touch = event.touches[0];
    lastTouchX = touch.clientX;
    lastTouchY = touch.clientY;
  });

  draggableElement.addEventListener("touchmove", function (event) {
    // 阻止默认的滚动行为
    event.preventDefault();

    // 获取当前触摸的位置
    const touch = event.touches[0];
    const currentTouchX = touch.clientX;
    const currentTouchY = touch.clientY;

    // 计算移动距离
    const deltaX = currentTouchX - lastTouchX;
    const deltaY = currentTouchY - lastTouchY;

    // 获取元素当前的位置
    let elementX = parseFloat(draggableElement.style.left) || 0;
    let elementY = parseFloat(draggableElement.style.top) || 0;

    // 更新元素的位置
    draggableElement.style.left = elementX + deltaX + "px";
    draggableElement.style.top = elementY + deltaY + "px";

    // 更新上一个触摸位置的坐标
    lastTouchX = currentTouchX;
    lastTouchY = currentTouchY;
  });

  draggableElement.addEventListener("touchend", function (event) {
    // 触摸结束时的处理（可选）
  });
}

function removeMusicBox() {
  var myBtn = document.querySelector(".close");
  myBtn.addEventListener("click", function () {
    var musicBox = document.querySelector(".move");
    musicBox.style.display = "none";
    musicBox.remove();
  });
}
function isMobile() {
  let flag = navigator.userAgent.match(
    /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i
  );
  return flag;
}
