// æ·»åŠ appç«¯æ ·å¼
addAppCss();
Jinx();
ipMap();

// ç»™ç©å¶æ·»åŠ æ‹–æ‹½äº‹ä»¶å’Œåˆ é™¤äº‹ä»¶
const interval = setInterval(() => {
  const element = document.getElementById('live2d-widget'); // æŸ¥æ‰¾å…ƒç´ 
  if (element) {
    moveDoll();
    console.log('å…ƒç´ å·²æ‰¾åˆ°ï¼Œæ¸…é™¤å®šæ—¶å™¨');
    clearInterval(interval); // æ¸…é™¤å®šæ—¶å™¨
  }
}, 500); // æ¯ 500ms æ£€æŸ¥ä¸€æ¬¡

 
// appç¯å¢ƒä¸æ·»åŠ ç½‘æ˜“äº‘å¤–é“¾
// appç¯å¢ƒç½‘æ˜“äº‘å¤–é“¾ä¸æ”¯æŒï¼Œè‡ªåŠ¨åŠ è½½httpçš„ä¸œè¥¿ï¼Œå’Œåšå®¢ç½‘ç«™httpså†²çª
if (isMobile()) {
  // moveDoll();
} else {
  musicBox();
  removeMusicBox();
}

function addMoveDollButton() {
  // è·å–å…ƒç´ 
  const live2dWidget = document.getElementById("live2d-widget");
  console.log(live2dWidget);
  if(live2dWidget) {
    const newDiv = document.createElement('div');
    newDiv.classList.add('close-doll');
    live2dWidget.appendChild(newDiv);
    var myBtn = document.querySelector(".close-doll");
    myBtn.addEventListener("click", function () {
      var doll = document.querySelector(".live2d-widget-container");
      doll.style.display = "none";
      doll.remove();
    });
  }
}
 
 
function moveDoll() {
    //æ·»åŠ åˆ é™¤æŒ‰é’®
    addMoveDollButton();

    // æ·»åŠ æ‹–æ‹½æŒ‰é’®
  const draggableElement = document.getElementById("live2d-widget");
  if (!draggableElement) {
    console.error("live2d-widget å…ƒç´ æœªæ‰¾åˆ°ï¼");
    return;
  }

  let isDragging = false;
  let offsetX = 0, offsetY = 0;

  // **PC ç«¯é¼ æ ‡äº‹ä»¶**
  draggableElement.addEventListener("mousedown", (event) => {
    isDragging = true;
    offsetX = event.clientX - draggableElement.getBoundingClientRect().left;
    offsetY = event.clientY - draggableElement.getBoundingClientRect().top;
    draggableElement.style.cursor = "grabbing";
  });

  document.addEventListener("mousemove", (event) => {
    if (isDragging) {
      moveAt(event.clientX, event.clientY);
    }
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
    draggableElement.style.cursor = "grab";
  });

  // **ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶**
  draggableElement.addEventListener("touchstart", (event) => {
    if (event.touches.length > 1) return; // é˜²æ­¢å¤šæŒ‡è§¦æ‘¸å¹²æ‰°

    isDragging = true;
    const touch = event.touches[0];
    offsetX = touch.clientX - draggableElement.getBoundingClientRect().left;
    offsetY = touch.clientY - draggableElement.getBoundingClientRect().top;
  });

  document.addEventListener("touchmove", (event) => {
    if (isDragging) {
      const touch = event.touches[0];
      moveAt(touch.clientX, touch.clientY);
      event.preventDefault(); // é˜»æ­¢æ»šåŠ¨é¡µé¢
    }
  }, { passive: false });

  document.addEventListener("touchend", () => {
    isDragging = false;
  });

  // **æ›´æ–°ä½ç½®**
  function moveAt(x, y) {
    let newX = x - offsetX;
    let newY = y - offsetY;

    // **é˜²æ­¢è¶…å‡ºå±å¹•**
    newX = Math.max(0, Math.min(window.innerWidth - draggableElement.clientWidth, newX));
    newY = Math.max(0, Math.min(window.innerHeight - draggableElement.clientHeight, newY));

    draggableElement.style.left = `${newX}px`;
    draggableElement.style.top = `${newY}px`;
  }
}


// å†™è¿™é‡Œåº”è¯¥æ²¡äººå‘ç°å§ğŸ˜ƒğŸ˜ƒğŸ˜ƒ
function Jinx() {
  console.log(
    "%c Jinxå¤©å¤©å¼€å¿ƒå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ %c https://jinx66.gitee.io/",
    "color:#fff;font-size: 14px;font-family: serif;background:linear-gradient(90deg,#ff4d91,#ff4d91);padding:15px 10px;",
    "color:#000;background:linear-gradient(90deg,#ff4d91,#ffffff);padding:15px 10px;font-size: 14px;font-family: serif;"
  );
}

function ipMap() {
  //æ·»åŠ iframeæ ‡ç­¾
  var body = document.getElementsByTagName("body");
  var div = document.createElement("div");
  div.innerHTML =
    '<a href="https://clustrmaps.com/site/1bv4l" title="Visit tracker"><img src="//www.clustrmaps.com/map_v2.png?d=NN6CrFgiT6g5STfQdgu1v91lB8TY5dqmU7iLIxocfY0&cl=ffffff"></a>';
  div.id = "ip-map";
  document.body.appendChild(div);
}
function addAppCss() {
  if (isMobile()) {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "/app.css"; // æ›¿æ¢ä¸ºæ‚¨CSSæ–‡ä»¶çš„è·¯å¾„
    document.head.appendChild(link);
  }
}
function musicBox() {
  //æ·»åŠ iframeæ ‡ç­¾
  var body = document.getElementsByTagName("body");
  var div = document.createElement("div");
  div.innerHTML =
    '<div id="drag" class="move"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=300 src="https://music.163.com/outchain/player?type=0&id=2327585234&auto=1&height=430"></iframe><div class="mask"></div><div class="close"></div></div>';
  document.body.appendChild(div);
  // æ‹–æ‹½åŠŸèƒ½(ä¸»è¦æ˜¯è§¦å‘ä¸‰ä¸ªäº‹ä»¶ï¼šonmousedown\onmousemove\onmouseup)
  var drag = document.getElementById("drag");
  var divMask = document.querySelector(".mask");

  // ç‚¹å‡»æŸç‰©ä½“æ—¶ï¼Œç”¨dragå¯¹è±¡å³å¯ï¼Œmoveå’Œupæ˜¯å…¨å±€åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªæ–‡æ¡£é€šç”¨ï¼Œåº”è¯¥ä½¿ç”¨documentå¯¹è±¡è€Œä¸æ˜¯dragå¯¹è±¡(å¦åˆ™ï¼Œé‡‡ç”¨dragå¯¹è±¡æ—¶ç‰©ä½“åªèƒ½å¾€å³æ–¹æˆ–ä¸‹æ–¹ç§»åŠ¨)
  drag.onmousedown = function (e) {
    var e = e || window.event; // å…¼å®¹ieæµè§ˆå™¨
    var diffX = e.clientX - drag.offsetLeft; // é¼ æ ‡ç‚¹å‡»ç‰©ä½“é‚£ä¸€åˆ»ç›¸å¯¹äºç‰©ä½“å·¦ä¾§è¾¹æ¡†çš„è·ç¦»=ç‚¹å‡»æ—¶çš„ä½ç½®ç›¸å¯¹äºæµè§ˆå™¨æœ€å·¦è¾¹çš„è·ç¦»-ç‰©ä½“å·¦è¾¹æ¡†ç›¸å¯¹äºæµè§ˆå™¨æœ€å·¦è¾¹çš„è·ç¦»
    var diffY = e.clientY - drag.offsetTop;

    /* ä½ç‰ˆæœ¬ie bug:ç‰©ä½“è¢«æ‹–å‡ºæµè§ˆå™¨å¯æ˜¯çª—å£å¤–éƒ¨æ—¶ï¼Œè¿˜ä¼šå‡ºç°æ»šåŠ¨æ¡ï¼Œ
                      è§£å†³æ–¹æ³•æ˜¯é‡‡ç”¨ieæµè§ˆå™¨ç‹¬æœ‰çš„2ä¸ªæ–¹æ³•setCapture()\releaseCapture(),è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œ
                      å¯ä»¥è®©é¼ æ ‡æ»‘åŠ¨åˆ°æµè§ˆå™¨å¤–éƒ¨ä¹Ÿå¯ä»¥æ•è·åˆ°äº‹ä»¶ï¼Œè€Œæˆ‘ä»¬çš„bugå°±æ˜¯å½“é¼ æ ‡ç§»å‡ºæµè§ˆå™¨çš„æ—¶å€™ï¼Œ
                      é™åˆ¶è¶…è¿‡çš„åŠŸèƒ½å°±å¤±æ•ˆäº†ã€‚ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå³å¯è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ³¨ï¼šè¿™ä¸¤ä¸ªæ–¹æ³•ç”¨äºonmousedownå’Œonmouseupä¸­ */
    if (typeof drag.setCapture !== "undefined") {
      drag.setCapture();
    }

    divMask.style.width = "100%";
    divMask.style.height = "100%";
    document.onmousemove = function (e) {
      var e = e || window.event; // å…¼å®¹ieæµè§ˆå™¨
      var left = e.clientX - diffX;
      var top = e.clientY - diffY;

      // æ§åˆ¶æ‹–æ‹½ç‰©ä½“çš„èŒƒå›´åªèƒ½åœ¨æµè§ˆå™¨è§†çª—å†…ï¼Œä¸å…è®¸å‡ºç°æ»šåŠ¨æ¡
      if (left < 0) {
        left = 0;
      } else if (left > window.innerWidth - drag.offsetWidth) {
        left = window.innerWidth - drag.offsetWidth;
      }
      if (top < 0) {
        top = 0;
      } else if (top > window.innerHeight - drag.offsetHeight) {
        top = window.innerHeight - drag.offsetHeight;
      }

      // ç§»åŠ¨æ—¶é‡æ–°å¾—åˆ°ç‰©ä½“çš„è·ç¦»ï¼Œè§£å†³æ‹–åŠ¨æ—¶å‡ºç°æ™ƒåŠ¨çš„ç°è±¡
      drag.style.left = left + "px";
      drag.style.top = top + "px";
    };
    document.onmouseup = function (e) {
      // å½“é¼ æ ‡å¼¹èµ·æ¥çš„æ—¶å€™ä¸å†ç§»åŠ¨
      console.log("this", this);
      this.onmousemove = null;
      this.onmouseup = null; // é¢„é˜²é¼ æ ‡å¼¹èµ·æ¥åè¿˜ä¼šå¾ªç¯ï¼ˆå³é¢„é˜²é¼ æ ‡æ”¾ä¸Šå»çš„æ—¶å€™è¿˜ä¼šç§»åŠ¨ï¼‰

      // ä¿®å¤ä½ç‰ˆæœ¬ie bug
      if (typeof drag.releaseCapture !== "undefined") {
        drag.releaseCapture();
      }

      divMask.style.width = "0";
      divMask.style.height = "0";
    };
  };
  const draggableElement = document.getElementById("drag");

  // å­˜å‚¨ä¸Šä¸€ä¸ªè§¦æ‘¸ä½ç½®çš„åæ ‡
  let lastTouchX = 0;
  let lastTouchY = 0;

  draggableElement.addEventListener("touchstart", function (event) {
    // è®°å½•è§¦æ‘¸å¼€å§‹æ—¶çš„ä½ç½®
    const touch = event.touches[0];
    lastTouchX = touch.clientX;
    lastTouchY = touch.clientY;
  });

  draggableElement.addEventListener("touchmove", function (event) {
    // é˜»æ­¢é»˜è®¤çš„æ»šåŠ¨è¡Œä¸º
    event.preventDefault();

    // è·å–å½“å‰è§¦æ‘¸çš„ä½ç½®
    const touch = event.touches[0];
    const currentTouchX = touch.clientX;
    const currentTouchY = touch.clientY;

    // è®¡ç®—ç§»åŠ¨è·ç¦»
    const deltaX = currentTouchX - lastTouchX;
    const deltaY = currentTouchY - lastTouchY;

    // è·å–å…ƒç´ å½“å‰çš„ä½ç½®
    let elementX = parseFloat(draggableElement.style.left) || 0;
    let elementY = parseFloat(draggableElement.style.top) || 0;

    // æ›´æ–°å…ƒç´ çš„ä½ç½®
    draggableElement.style.left = elementX + deltaX + "px";
    draggableElement.style.top = elementY + deltaY + "px";

    // æ›´æ–°ä¸Šä¸€ä¸ªè§¦æ‘¸ä½ç½®çš„åæ ‡
    lastTouchX = currentTouchX;
    lastTouchY = currentTouchY;
  });

  draggableElement.addEventListener("touchend", function (event) {
    // è§¦æ‘¸ç»“æŸæ—¶çš„å¤„ç†ï¼ˆå¯é€‰ï¼‰
  });
}

function removeMusicBox() {
  var myBtn = document.querySelector(".close");
  myBtn.addEventListener("click", function () {
    var musicBox = document.querySelector(".move");
    musicBox.style.display = "none";
    musicBox.remove();
  });
}
function isMobile() {
  let flag = navigator.userAgent.match(
    /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i
  );
  return flag;
}
